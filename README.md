# 🌐 微网数字孪生系统

一个集成预测、强化学习能量管理和3D可视化的智能微网数字孪生系统。

## ✨ 主要特性

### 1. 📊 微网数字孪生核心仿真
- **发电模块**: 太阳能光伏（100kW）、风力发电（80kW）
- **储能模块**: 电池储能系统（200kWh，最大功率50kW）
- **负荷模块**: 动态负荷模拟，包含典型日负荷曲线
- **电网接口**: 双向功率交换，峰谷电价机制
- **物理仿真**: 真实的能量平衡、电池SOC管理、效率建模

### 2. 🔮 预测系统
- **多变量预测**: 太阳能功率、风电功率、负荷需求、电价
- **LSTM神经网络**: 基于时间序列的深度学习预测
- **预测误差模拟**: 可配置的预测误差水平，更真实模拟实际应用
- **自适应学习**: 持续更新历史数据，提高预测精度

### 3. 🤖 强化学习能量管理
- **PPO算法**: Proximal Policy Optimization，先进的策略梯度算法
- **自适应策略**: 根据预测误差自动调整能量管理策略
- **多目标优化**: 
  - 最小化运行成本
  - 最大化可再生能源利用率
  - 保护电池健康
  - 平滑电网功率波动
- **对比控制器**: 提供基于规则的控制器作为基准

### 4. 🌍 3D实时可视化
- **美观的3D场景**: 
  - 太阳能电池板阵列（金色）
  - 风力涡轮机带旋转叶片（蓝色）
  - 储能电池动态显示SOC（绿色）
  - 负荷建筑群（紫色）
  - 电网连接塔（红色）
- **能量流动效果**: 实时动画显示能量流向
- **交互式场景**: 可旋转、缩放、查看不同角度
- **多种视图**: 
  - 3D场景视图
  - 能量流桑基图
  - 数据仪表盘

### 5. 💬 自然语言查询
- 中文语义理解
- 支持查询：
  - 系统概览
  - 电池状态
  - 成本信息
  - 可再生能源使用率
  - 各组件功率状态

### 6. 📈 策略评估
- 实时性能监控
- 多指标评估：
  - 运行成本
  - 可再生能源占比
  - 电池健康度
  - 电网依赖度

## 🚀 快速开始

### 在Google Colab中运行

1. 打开Colab笔记本
2. 安装依赖：

```python
!pip install -q torch torchvision numpy pandas plotly gradio scipy scikit-learn tqdm
```

3. 克隆代码或上传文件
4. 运行主程序：

```python
!python main_app.py
```

5. 系统会自动生成一个公共链接（share link），点击链接即可访问Web界面

### 在本地运行

1. 安装Python 3.8+

2. 安装依赖：

```bash
pip install -r requirements.txt
```

3. 运行主程序：

```bash
python main_app.py
```

4. 打开浏览器访问 `http://localhost:7860`

## 📖 使用指南

### 系统控制

#### 控制模式
- **RL模式**: 使用强化学习智能体自动控制（推荐）
- **Rule模式**: 使用基于规则的控制器
- **Manual模式**: 手动控制电池和电网功率

#### 操作步骤
1. **重置系统**: 开始新的仿真周期
2. **单步运行**: 逐步观察系统行为
3. **连续运行**: 快速仿真多个时间步
4. **训练RL智能体**: 让AI学习更好的控制策略

### 3D可视化

- **旋转视图**: 鼠标左键拖动
- **缩放**: 鼠标滚轮
- **平移**: 鼠标右键拖动
- **查看详情**: 鼠标悬停在组件上

颜色含义：
- 🟡 金色: 太阳能发电
- 🔵 蓝色: 风力发电
- 🟢 绿色: 储能电池
- 🟣 紫色: 用电负荷
- 🔴 红色: 电网连接

### 预测系统

1. 运行系统积累历史数据
2. 设置预测时间范围（1-12个时间步）
3. 调整预测误差水平模拟不同预测精度
4. 查看预测结果与实际值对比

### 智能查询

支持的查询示例：
- "当前系统概览"
- "电池状态如何"
- "太阳能发电是多少"
- "总成本是多少"
- "可再生能源使用率"

## 🏗️ 系统架构

```
microgrid-digital-twin/
├── microgrid_digital_twin.py    # 核心仿真引擎
├── prediction_system.py          # 预测系统
├── rl_energy_management.py       # 强化学习能量管理
├── visualization_3d.py           # 3D可视化
├── main_app.py                   # 主应用和Gradio界面
├── requirements.txt              # 依赖包
└── README.md                     # 说明文档
```

### 核心模块

#### MicrogridDigitalTwin
数字孪生核心，包含：
- 物理模型仿真
- 能量平衡计算
- 状态管理
- 历史记录

#### MicrogridPredictor
预测系统，包含：
- LSTM神经网络
- 多变量预测
- 误差模拟
- 精度评估

#### RLEnergyManager
强化学习管理器，包含：
- PPO智能体
- 训练算法
- 策略评估
- 性能统计

#### Microgrid3DVisualizer
3D可视化器，包含：
- 场景构建
- 动态效果
- 能量流动画
- 多视图支持

## 🔬 技术细节

### 仿真参数

- **时间步长**: 15分钟
- **仿真周期**: 7天（672个时间步）
- **太阳能容量**: 100 kW
- **风电容量**: 80 kW
- **电池容量**: 200 kWh
- **电池最大功率**: 50 kW
- **电池效率**: 95%
- **电网最大功率**: 150 kW

### 强化学习设置

- **算法**: PPO (Proximal Policy Optimization)
- **状态空间**: 9维（当前状态 + 预测信息）
- **动作空间**: 2维（电池功率比例、电网功率比例）
- **奖励函数**: 
  - 负成本
  - 可再生能源使用奖励
  - 电网波动惩罚
  - 电池健康惩罚

### 预测模型

- **模型类型**: LSTM神经网络
- **输入**: 历史24个时间步数据
- **输出**: 未来4个时间步预测
- **特征**: 功率值、时间信息、周期特征

## 📊 性能指标

系统评估以下指标：

1. **经济性**: 
   - 总运行成本
   - 峰谷电价利用效率

2. **环境性**: 
   - 可再生能源使用率
   - 碳排放减少量

3. **可靠性**: 
   - 电池健康度
   - 电网依赖度
   - 负荷满足率

4. **预测性能**: 
   - MAPE (平均绝对百分比误差)
   - RMSE (均方根误差)

## 🎯 应用场景

1. **能源管理优化**: 实时优化微网运行策略
2. **策略评估**: 对比不同控制策略的效果
3. **预测研究**: 研究预测误差对系统性能的影响
4. **教育演示**: 可视化展示微网运行原理
5. **决策支持**: 为能源规划提供数据支持

## 🔧 自定义配置

### 修改微网参数

编辑 `microgrid_digital_twin.py` 中的配置：

```python
config = {
    'solar_capacity': 100,      # 太阳能容量
    'wind_capacity': 80,        # 风电容量
    'battery_capacity': 200,    # 电池容量
    'battery_max_power': 50,    # 电池最大功率
    'battery_efficiency': 0.95, # 电池效率
    'grid_max_power': 150,      # 电网最大功率
    'initial_soc': 0.5,         # 初始SOC
    'time_step_hours': 0.25,    # 时间步长（小时）
}
```

### 调整预测误差

在Web界面的"预测系统"标签页中调整滑块，或在代码中：

```python
predictor.set_error_levels(
    solar_err=0.15,   # 15%误差
    wind_err=0.20,    # 20%误差
    load_err=0.10,    # 10%误差
    price_err=0.08    # 8%误差
)
```

### 修改强化学习参数

编辑 `rl_energy_management.py` 中的PPOAgent参数：

```python
agent = PPOAgent(
    state_dim=9,
    action_dim=2,
    lr=3e-4,          # 学习率
    gamma=0.99,       # 折扣因子
    eps_clip=0.2,     # PPO裁剪参数
    k_epochs=10       # 更新轮数
)
```

## 🐛 故障排除

### Colab显示问题

如果Gradio界面在Colab中无法正常显示：

1. 确保使用 `share=True` 参数
2. 点击生成的公共链接
3. 如果链接失效，重新运行程序

### 内存不足

如果遇到内存问题：

1. 减少训练episodes数
2. 缩短仿真周期
3. 使用CPU而非GPU（`device='cpu'`）

### 3D可视化卡顿

如果3D场景响应慢：

1. 减少场景中的组件数量
2. 降低网格密度
3. 使用更强大的浏览器（推荐Chrome）

## 📚 参考资料

- **强化学习**: Proximal Policy Optimization (Schulman et al., 2017)
- **微网建模**: IEEE 标准微网参考模型
- **时间序列预测**: LSTM网络 (Hochreiter & Schmidhuber, 1997)

## 🤝 贡献

欢迎提交问题和改进建议！

## 📄 许可证

MIT License

## 👨‍💻 作者

微网数字孪生系统开发团队

---

## 🎉 开始使用

```bash
# 克隆项目
git clone <repository-url>
cd microgrid-digital-twin

# 安装依赖
pip install -r requirements.txt

# 运行系统
python main_app.py
```

享受探索微网数字孪生世界的乐趣！🌐⚡
