# 微网数字孪生系统 (Microgrid Digital Twin System)

一个完整的微网数字孪生系统，包含预测、强化学习能量管理、3D可视化和自然语言接口。

## 功能特性

### 1. 预测系统
- **功率预测**: 光伏和风电发电功率预测
- **电价预测**: 基于时间模式的电价预测
- **负荷预测**: 考虑日/周模式的负荷需求预测
- **预测误差处理**: 支持可配置的预测误差模拟

### 2. 强化学习能量管理
- **DQN算法**: 使用深度Q网络学习最优能量管理策略
- **自适应策略**: 能够根据预测误差自适应调整策略
- **策略评估**: 支持多种策略的性能评估和对比

### 3. 数字孪生系统
- **实时仿真**: 模拟微网运行状态
- **状态跟踪**: 实时跟踪电池SOC、功率流、成本等
- **历史数据**: 保存运行历史数据用于分析

### 4. 3D可视化
- **Three.js渲染**: 使用WebGL实现流畅的3D可视化
- **实时更新**: 实时反映系统状态变化
- **交互式控制**: 支持鼠标旋转、缩放、平移
- **美观界面**: 现代化的UI设计

### 5. 自然语言接口
- **中文支持**: 支持中文自然语言查询
- **多意图识别**: 支持状态查询、预测、评估等多种意图
- **智能响应**: 返回结构化的系统信息

## 系统架构

```
微网数字孪生系统
├── 预测系统 (predictors.py)
│   ├── 功率预测器
│   ├── 电价预测器
│   └── 负荷预测器
├── 强化学习能量管理 (rl_energy_manager.py)
│   ├── 微网环境
│   ├── DQN智能体
│   └── 策略评估
├── 数字孪生核心 (digital_twin.py)
│   ├── 系统仿真
│   ├── 状态管理
│   └── 数据记录
├── 自然语言接口 (nlp_interface.py)
│   └── 查询处理
├── Web服务器 (app.py)
│   └── REST API
└── 3D可视化前端
    ├── HTML界面
    ├── Three.js渲染
    └── 实时数据更新
```

## 安装和运行

### 本地运行

1. **安装依赖**
```bash
pip install -r requirements.txt
```

2. **运行系统**
```bash
python app.py
```

3. **访问界面**
打开浏览器访问: http://localhost:5000

### Google Colab运行

1. **打开Colab笔记本**
   - 上传 `run_colab.ipynb` 到Colab
   - 或直接创建新笔记本并复制代码

2. **安装依赖**
```python
!pip install -q numpy pandas scikit-learn torch gym stable-baselines3 flask flask-cors matplotlib plotly dash dash-bootstrap-components pyngrok tornado
```

3. **上传项目文件**
   - 将所有Python文件上传到Colab
   - 或使用git clone

4. **启动系统**
```python
from colab_main import run_in_colab
run_in_colab()
```

5. **使用ngrok暴露端口**
```python
from pyngrok import ngrok
public_url = ngrok.connect(5000)
print(f"访问地址: {public_url}")
```

## 使用说明

### Web界面操作

1. **查看3D可视化**
   - 系统自动显示3D微网场景
   - 使用鼠标拖拽旋转视角
   - 滚轮缩放

2. **控制面板**
   - **开始**: 启动实时仿真
   - **停止**: 停止仿真
   - **重置**: 重置系统状态

3. **自然语言查询**
   - 在查询框中输入问题，例如:
     - "系统状态如何？"
     - "电池电量多少？"
     - "未来24小时预测"
     - "评估RL策略性能"

### API接口

#### 获取系统状态
```bash
GET /api/status
```

#### 执行一步仿真
```bash
POST /api/step
Body: {"action": 10}  # 可选，电池功率
```

#### 评估策略
```bash
POST /api/evaluate
Body: {"strategy": "rl", "horizon": 24}
```

#### 自然语言查询
```bash
POST /api/nlp
Body: {"query": "系统状态如何？"}
```

#### 控制仿真
```bash
POST /api/control
Body: {"action": "start"}  # start/stop/reset
```

## 配置说明

系统配置在 `config.py` 中，可以调整:

- **系统参数**: 电池容量、功率限制、效率等
- **预测参数**: 预测误差标准差等
- **RL参数**: 学习率、折扣因子等
- **可视化参数**: 更新间隔、历史长度等

## 系统组件说明

### 微网组件

- **电池储能**: 100 kWh容量，50 kW最大功率
- **光伏发电**: 80 kW容量
- **风电发电**: 60 kW容量
- **负荷**: 动态变化，10-150 kW
- **电网连接**: 双向功率交换

### 可视化元素

- **电池**: 蓝色容器，SOC指示器
- **光伏板**: 8块倾斜面板，根据发电量发光
- **风机**: 3台风力发电机，根据风速旋转
- **负荷建筑**: 带窗户的建筑，根据负荷亮度变化
- **电网连接**: 黄色连接线，根据功率流变色

## 故障排除

### Colab无法显示3D界面

1. **使用ngrok**: 获取公共URL访问
2. **本地运行**: 下载代码在本地运行
3. **检查控制台**: 查看浏览器控制台错误信息

### 系统运行缓慢

1. **减少训练轮数**: 修改 `rl_energy_manager.py` 中的训练episodes
2. **降低更新频率**: 修改 `app.js` 中的更新间隔
3. **简化3D场景**: 减少可视化对象数量

### 预测不准确

1. **调整误差参数**: 修改 `config.py` 中的 `prediction_error_std`
2. **重新训练模型**: 删除模型缓存重新训练
3. **增加训练数据**: 修改预测器的训练数据生成

## 开发计划

- [ ] 支持更多RL算法 (PPO, SAC等)
- [ ] 添加更多可视化效果
- [ ] 支持多微网互联
- [ ] 添加数据导出功能
- [ ] 优化Colab兼容性

## 许可证

MIT License

## 作者

微网数字孪生系统开发团队

## 联系方式

如有问题或建议，请提交Issue。
