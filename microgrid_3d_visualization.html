
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ç½‘æ•°å­—å­ªç”Ÿ3Då¯è§†åŒ–ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .overlay {
            position: absolute;
            z-index: 100;
            pointer-events: auto;
        }
        
        #header {
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(15, 52, 96, 0.95) 0%, rgba(15, 52, 96, 0.7) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(100, 200, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        #header h1 {
            font-size: 1.5em;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        #time-display {
            font-size: 1.2em;
            color: #4ecdc4;
        }
        
        #status-panel {
            top: 80px;
            left: 20px;
            width: 280px;
            background: rgba(15, 52, 96, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #chart-panel {
            bottom: 20px;
            left: 20px;
            right: 320px;
            height: 200px;
            background: rgba(15, 52, 96, 0.85);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        #control-panel {
            top: 80px;
            right: 20px;
            width: 280px;
            background: rgba(15, 52, 96, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #chat-panel {
            bottom: 20px;
            right: 20px;
            width: 280px;
            height: 350px;
            background: rgba(15, 52, 96, 0.9);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        .panel-title {
            font-size: 1.1em;
            color: #00d4ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-label {
            color: #aaa;
        }
        
        .status-value {
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .status-value.warning {
            color: #ffa500;
        }
        
        .status-value.danger {
            color: #ff6b6b;
        }
        
        .status-value.good {
            color: #2ecc71;
        }
        
        .control-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 90%;
        }
        
        .chat-message.user {
            background: #00d4ff;
            color: white;
            margin-left: auto;
        }
        
        .chat-message.system {
            background: rgba(255, 255, 255, 0.1);
            color: #e8e8e8;
        }
        
        #chat-input-container {
            display: flex;
            gap: 8px;
        }
        
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }
        
        #chat-input:focus {
            border-color: #00d4ff;
        }
        
        #send-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #00d4ff;
            color: white;
            cursor: pointer;
        }
        
        .power-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .power-bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .power-bar-fill.solar {
            background: linear-gradient(90deg, #f39c12, #f1c40f);
        }
        
        .power-bar-fill.wind {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }
        
        .power-bar-fill.battery {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }
        
        .power-bar-fill.load {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        #legend {
            position: absolute;
            bottom: 240px;
            left: 20px;
            background: rgba(15, 52, 96, 0.85);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(100, 200, 255, 0.2);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        #metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px 20px;
            position: absolute;
            bottom: 240px;
            left: 320px;
            right: 320px;
        }
        
        .metric-card {
            background: rgba(15, 52, 96, 0.85);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }
        
        canvas {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulsing {
            animation: pulse 2s infinite;
        }
        
        .glow {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        /* è¯¦ç»†ç•Œé¢æ¨¡æ€æ¡† */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .detail-modal.active {
            display: flex;
        }
        
        .detail-content {
            background: rgba(15, 52, 96, 0.95);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(100, 200, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(100, 200, 255, 0.2);
        }
        
        .detail-title {
            font-size: 1.5em;
            color: #00d4ff;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
            padding: 0 10px;
        }
        
        .detail-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .detail-item {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .detail-label {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #00d4ff;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* ç­–ç•¥é¢æ¿ */
        #strategy-panel {
            top: 80px;
            left: 320px;
            width: 400px;
            max-height: calc(100vh - 100px);
            background: rgba(15, 52, 96, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(100, 200, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        
        .strategy-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(100, 200, 255, 0.2);
        }
        
        .strategy-tab {
            padding: 10px 15px;
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .strategy-tab.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }
        
        .strategy-content {
            display: none;
        }
        
        .strategy-content.active {
            display: block;
        }
        
        .strategy-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .comparison-table th {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .comparison-table tr:hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        /* å¯ç‚¹å‡»æç¤º */
        .clickable-hint {
            position: absolute;
            background: rgba(0, 212, 255, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .clickable-hint.show {
            opacity: 1;
        }
        
        /* 3Då¯¹è±¡é«˜äº® */
        .highlighted {
            outline: 2px solid #00d4ff;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-container"></div>
        
        <!-- ç‚¹å‡»æç¤º -->
        <div id="click-hint" class="clickable-hint"></div>
        
        <!-- è¯¦ç»†ç•Œé¢æ¨¡æ€æ¡† -->
        <div id="detail-modal" class="detail-modal">
            <div class="detail-content">
                <div class="detail-header">
                    <div class="detail-title" id="detail-title">è®¾å¤‡è¯¦æƒ…</div>
                    <button class="close-btn" onclick="closeDetailModal()">&times;</button>
                </div>
                <div id="detail-body"></div>
            </div>
        </div>
        
        <!-- Header -->
        <div id="header" class="overlay">
            <h1>ğŸ”Œ å¾®ç½‘æ•°å­—å­ªç”Ÿç³»ç»Ÿ - 3Då¯è§†åŒ–æ§åˆ¶ä¸­å¿ƒ</h1>
            <div id="time-display">--:--:--</div>
        </div>
        
        <!-- Status Panel -->
        <div id="status-panel" class="overlay">
            <div class="panel-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€ç›‘æ§</div>
            
            <div class="status-item">
                <span class="status-label">â˜€ï¸ å…‰ä¼å‘ç”µ</span>
                <span class="status-value" id="solar-power">-- kW</span>
            </div>
            <div class="power-bar">
                <div class="power-bar-fill solar" id="solar-bar" style="width: 0%"></div>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸ’¨ é£åŠ›å‘ç”µ</span>
                <span class="status-value" id="wind-power">-- kW</span>
            </div>
            <div class="power-bar">
                <div class="power-bar-fill wind" id="wind-bar" style="width: 0%"></div>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸ”‹ ç”µæ± SOC</span>
                <span class="status-value" id="battery-soc">--%</span>
            </div>
            <div class="power-bar">
                <div class="power-bar-fill battery" id="battery-bar" style="width: 50%"></div>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸ“ˆ è´Ÿè·åŠŸç‡</span>
                <span class="status-value" id="load-power">-- kW</span>
            </div>
            <div class="power-bar">
                <div class="power-bar-fill load" id="load-bar" style="width: 0%"></div>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸ’° ç”µä»·</span>
                <span class="status-value" id="price">Â¥--/kWh</span>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸŒ¡ï¸ æ¸©åº¦</span>
                <span class="status-value" id="temperature">--Â°C</span>
            </div>
            
            <div class="status-item">
                <span class="status-label">ğŸŒ¿ å¯å†ç”Ÿæ¯”ä¾‹</span>
                <span class="status-value good" id="renewable-ratio">--%</span>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div id="control-panel" class="overlay">
            <div class="panel-title">ğŸ® èƒ½é‡ç®¡ç†æ§åˆ¶</div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>ç”µæ± æ§åˆ¶</span>
                    <span id="battery-action-value">0%</span>
                </div>
                <input type="range" id="battery-slider" min="-100" max="100" value="0">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #888;">
                    <span>æ”¾ç”µ</span>
                    <span>å……ç”µ</span>
                </div>
            </div>
            
            <button class="control-btn btn-primary" id="btn-auto">
                ğŸ¤– è‡ªåŠ¨æ¨¡å¼
            </button>
            
            <button class="control-btn btn-success" id="btn-charge">
                âš¡ å¿«é€Ÿå……ç”µ
            </button>
            
            <button class="control-btn btn-warning" id="btn-discharge">
                ğŸ”‹ ç«‹å³æ”¾ç”µ
            </button>
            
            <button class="control-btn btn-danger" id="btn-diesel">
                ğŸ­ æŸ´æ²¹æœºå¼€å…³
            </button>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="panel-title" style="font-size: 0.95em;">âš™ï¸ æ¨¡æ‹Ÿæ§åˆ¶</div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>æ¨¡æ‹Ÿé€Ÿåº¦</span>
                        <span id="speed-value">1x</span>
                    </div>
                    <input type="range" id="speed-slider" min="1" max="10" value="1">
                </div>
                
                <button class="control-btn btn-primary" id="btn-play">
                    â–¶ï¸ å¼€å§‹æ¨¡æ‹Ÿ
                </button>
                
                <button class="control-btn btn-warning" id="btn-reset">
                    ğŸ”„ é‡ç½®ç³»ç»Ÿ
                </button>
            </div>
        </div>
        
        <!-- Metrics Grid -->
        <div id="metrics-grid" class="overlay">
            <div class="metric-card">
                <div class="metric-value" id="total-cost">Â¥0.00</div>
                <div class="metric-label">ç´¯è®¡æˆæœ¬</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-energy">0 kWh</div>
                <div class="metric-label">æ€»å‘ç”µé‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="co2-saved">0 kg</div>
                <div class="metric-label">CO2å‡æ’</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="efficiency">0%</div>
                <div class="metric-label">ç³»ç»Ÿæ•ˆç‡</div>
            </div>
        </div>
        
        <!-- Chart Panel -->
        <div id="chart-panel" class="overlay">
            <canvas id="power-chart"></canvas>
        </div>
        
        <!-- Legend -->
        <div id="legend" class="overlay">
            <div class="legend-item">
                <div class="legend-color" style="background: #f1c40f;"></div>
                <span>å…‰ä¼é˜µåˆ—</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>é£åŠ›å‘ç”µ</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>å‚¨èƒ½ç”µæ± </span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>è´Ÿè·ä¸­å¿ƒ</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>ç”µç½‘è¿æ¥</span>
            </div>
        </div>
        
        <!-- Strategy Panel -->
        <div id="strategy-panel" class="overlay">
            <div class="panel-title">ğŸ“ˆ ç­–ç•¥ç®¡ç†</div>
            
            <div class="strategy-tabs">
                <button class="strategy-tab active" onclick="switchStrategyTab('execution')">æ‰§è¡Œæƒ…å†µ</button>
                <button class="strategy-tab" onclick="switchStrategyTab('comparison')">ç­–ç•¥å¯¹æ¯”</button>
            </div>
            
            <!-- ç­–ç•¥æ‰§è¡Œæƒ…å†µ -->
            <div id="strategy-execution" class="strategy-content active">
                <div class="panel-title" style="font-size: 0.95em;">å½“å‰ç­–ç•¥æ‰§è¡Œ</div>
                
                <div class="strategy-metric">
                    <span>å½“å‰ç­–ç•¥:</span>
                    <span id="current-strategy">è‡ªé€‚åº”æ··åˆç­–ç•¥</span>
                </div>
                
                <div class="strategy-metric">
                    <span>RLç½®ä¿¡åº¦:</span>
                    <span id="rl-confidence">--%</span>
                </div>
                
                <div class="strategy-metric">
                    <span>æ¢ç´¢ç‡(Îµ):</span>
                    <span id="epsilon-value">--</span>
                </div>
                
                <div class="strategy-metric">
                    <span>è®­ç»ƒæ­¥æ•°:</span>
                    <span id="training-steps">0</span>
                </div>
                
                <div class="strategy-metric">
                    <span>ç»éªŒæ± å¤§å°:</span>
                    <span id="buffer-size">0</span>
                </div>
                
                <div class="strategy-metric">
                    <span>è¿‘æœŸæ€§èƒ½:</span>
                    <span id="recent-performance">--</span>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="panel-title" style="font-size: 0.95em;">å½“å‰åŠ¨ä½œ</div>
                    <div class="strategy-metric">
                        <span>ç”µæ± åŠ¨ä½œ:</span>
                        <span id="current-battery-action">å¾…æœº</span>
                    </div>
                    <div class="strategy-metric">
                        <span>æŸ´æ²¹æœºçŠ¶æ€:</span>
                        <span id="current-diesel-status">å…³é—­</span>
                    </div>
                </div>
            </div>
            
            <!-- ç­–ç•¥å¯¹æ¯” -->
            <div id="strategy-comparison" class="strategy-content">
                <div class="panel-title" style="font-size: 0.95em;">ç­–ç•¥å¯¹æ¯”åˆ†æ</div>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>ç­–ç•¥</th>
                            <th>æˆæœ¬</th>
                            <th>å¯å†ç”Ÿ%</th>
                            <th>æ’å</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body">
                        <tr>
                            <td>RLç­–ç•¥</td>
                            <td id="rl-cost">--</td>
                            <td id="rl-renewable">--%</td>
                            <td id="rl-rank">--</td>
                        </tr>
                        <tr>
                            <td>è§„åˆ™ç­–ç•¥</td>
                            <td id="rule-cost">--</td>
                            <td id="rule-renewable">--%</td>
                            <td id="rule-rank">--</td>
                        </tr>
                        <tr>
                            <td>éšæœºç­–ç•¥</td>
                            <td id="random-cost">--</td>
                            <td id="random-renewable">--%</td>
                            <td id="random-rank">--</td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 15px;">
                    <button class="control-btn btn-primary" onclick="runStrategyComparison()" style="width: 100%;">
                        ğŸ”„ è¿è¡Œç­–ç•¥å¯¹æ¯”
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Chat Panel -->
        <div id="chat-panel" class="overlay">
            <div class="panel-title">ğŸ’¬ æ™ºèƒ½åŠ©æ‰‹</div>
            <div id="chat-messages">
                <div class="chat-message system">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯å¾®ç½‘æ•°å­—å­ªç”Ÿæ™ºèƒ½åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥è¯¢é—®ç³»ç»ŸçŠ¶æ€ã€æ§åˆ¶è®¾å¤‡æˆ–è·å–åˆ†ææŠ¥å‘Šã€‚
                </div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
    </div>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // åˆå§‹çŠ¶æ€æ•°æ®
        let systemState = {"timestamp": "2025-12-21T05:09:46.248075", "components": {"solar": {"capacity": 100.0, "current_power": 1.1288895455173251}, "wind": {"capacity": 50.0, "current_power": 8.809456173339116}, "battery": {"capacity": 200.0, "soc": 0.5, "health": 1.0}, "diesel": {"capacity": 100.0, "is_running": false, "run_hours": 0.0}, "load": {"current": 115.0, "base": 80.0, "peak": 150.0}, "grid": {"connected": true, "max_import": 100.0, "max_export": 50.0}}, "weather": {"irradiance": 11.76634412969153, "temperature": 8.493746354850991, "wind_speed": 8.04547673276006, "cloud_cover": 0.5721813387199156, "humidity": 64.0519425624945}, "price": {"buy_price": 0.4, "sell_price": 0.27999999999999997, "period": "valley"}, "statistics": {"total_cost": 34.56630354514924, "total_renewable_energy": 21.212408731999247, "total_energy_consumed": 110.31356808326024, "renewable_ratio": 0.19229192836903775}};
        let historyData = {"timestamp": ["2025-12-21T04:09:46.248075", "2025-12-21T04:10:46.248075", "2025-12-21T04:11:46.248075", "2025-12-21T04:12:46.248075", "2025-12-21T04:13:46.248075", "2025-12-21T04:14:46.248075", "2025-12-21T04:15:46.248075", "2025-12-21T04:16:46.248075", "2025-12-21T04:17:46.248075", "2025-12-21T04:18:46.248075", "2025-12-21T04:19:46.248075", "2025-12-21T04:20:46.248075", "2025-12-21T04:21:46.248075", "2025-12-21T04:22:46.248075", "2025-12-21T04:23:46.248075", "2025-12-21T04:24:46.248075", "2025-12-21T04:25:46.248075", "2025-12-21T04:26:46.248075", "2025-12-21T04:27:46.248075", "2025-12-21T04:28:46.248075", "2025-12-21T04:29:46.248075", "2025-12-21T04:30:46.248075", "2025-12-21T04:31:46.248075", "2025-12-21T04:32:46.248075", "2025-12-21T04:33:46.248075", "2025-12-21T04:34:46.248075", "2025-12-21T04:35:46.248075", "2025-12-21T04:36:46.248075", "2025-12-21T04:37:46.248075", "2025-12-21T04:38:46.248075", "2025-12-21T04:39:46.248075", "2025-12-21T04:40:46.248075", "2025-12-21T04:41:46.248075", "2025-12-21T04:42:46.248075", "2025-12-21T04:43:46.248075", "2025-12-21T04:44:46.248075", "2025-12-21T04:45:46.248075", "2025-12-21T04:46:46.248075", "2025-12-21T04:47:46.248075", "2025-12-21T04:48:46.248075", "2025-12-21T04:49:46.248075", "2025-12-21T04:50:46.248075", "2025-12-21T04:51:46.248075", "2025-12-21T04:52:46.248075", "2025-12-21T04:53:46.248075", "2025-12-21T04:54:46.248075", "2025-12-21T04:55:46.248075", "2025-12-21T04:56:46.248075", "2025-12-21T04:57:46.248075", "2025-12-21T04:58:46.248075", "2025-12-21T04:59:46.248075", "2025-12-21T05:00:46.248075", "2025-12-21T05:01:46.248075", "2025-12-21T05:02:46.248075", "2025-12-21T05:03:46.248075", "2025-12-21T05:04:46.248075", "2025-12-21T05:05:46.248075", "2025-12-21T05:06:46.248075", "2025-12-21T05:07:46.248075", "2025-12-21T05:08:46.248075"], "solar_power": [0.0, 1.9656017622443496, 0.0, 0.0, 0.0, 1.831015037901382, 0.0, 2.3080634771114177, 0.0, 0.0, 1.175603254245081, 0.0, 0.0, 0.0, 3.0894008861434346, 2.005516667677736, 0.0, 2.238868438597865, 1.8858480514870826, 0.0, 0.0, 2.719538925774288, 4.77758944195427, 0.0, 0.0, 0.14947522624558182, 0.0, 0.0, 0.0, 4.929672695391405, 1.528147406287288, 2.3532365462676395, 0.0, 0.0, 0.7945808562472652, 0.0, 2.820720076591938, 1.8919952201339711, 1.3779986127712445, 1.4932776546024393, 0.0, 0.0, 2.0618920373793133, 0.49806654306834836, 2.1837446290801283, 0.0, 0.0, 0.0, 0.419091340808315, 1.604959408305068, 1.6607068983778042, 3.2024987675485166, 0.7860889555202114, 3.206919795462904, 0.0, 0.0, 0.0, 4.501250197595666, 0.0, 2.473683635604738], "wind_power": [8.25501514257796, 8.59036986069284, 18.756023291566553, 30.99553034569847, 18.565301947560226, 13.095310836856221, 10.474345383568929, 50.0, 36.818324929939365, 33.03936434006463, 29.50022732784031, 7.255444384348812, 49.37892340454659, 16.711574780205662, 6.894159715828639, 9.486491710766526, 50.0, 8.630444162732017, 9.181083406741426, 9.100347336514101, 15.271138665121942, 10.291808865120597, 8.124354616348407, 28.541744338619175, 19.77011721899942, 8.629789337823688, 20.355578031696457, 8.039426397069143, 35.07769040516754, 50.0, 25.461658702927842, 6.74833505448928, 20.71132690422659, 27.153513501338733, 7.560514306369267, 19.653563522105472, 8.741689581613569, 8.511517837731178, 50.0, 10.563952933732164, 17.038366981953452, 26.66121192410426, 33.981081445668835, 14.74414944313058, 50.0, 6.991194887667315, 6.9407689771545185, 9.014447459239717, 15.984283202379848, 10.669225257678342, 6.893535515999721, 11.248814170400106, 50.0, 11.207623788752286, 16.21486224296981, 15.079904424257132, 13.636725544656997, 9.944535980111903, 50.0, 18.622737698853438], "load_power": [115.49249400880329, 107.704150807488, 86.8992563526913, 91.66709766102323, 134.22217256599254, 122.75596090704656, 113.40140364226633, 89.50402692918425, 116.8142205921569, 120.4304514416763, 101.16802229477963, 92.41284140358653, 131.12249602690542, 129.93267898503217, 97.15538505095402, 104.59949233291776, 126.98993113358858, 119.00290901077659, 104.49515642979756, 90.16393875576138, 115.59289887922407, 109.51828607210902, 118.90952304239728, 109.5019592597955, 113.70481468057876, 100.09769527257724, 101.51421030509329, 102.91517424108406, 111.74244295196846, 116.85649301144657, 99.82374104152385, 97.1975270201643, 97.30813293912661, 112.08301569185889, 121.44571931247066, 108.15989234341505, 126.13399185700369, 95.03289752346492, 110.0704132982168, 102.24244977286864, 109.67909052134857, 114.76612928049502, 114.45624460805965, 103.25159514067352, 125.95494733965427, 102.31265704069816, 119.1556237170163, 108.10794146956053, 139.98273321067876, 91.41592223128539, 98.75732888736695, 110.23243828636984, 112.68813133976076, 132.47470120387834, 109.76533417467657, 124.44681869946193, 112.08594402499735, 123.35124124199541, 97.29389054669778, 102.85000718212196], "battery_soc": [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5], "battery_power": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "grid_power": [100.0, 97.14817918455081, 68.14323306112475, 60.671567315324765, 100.0, 100.0, 100.0, 37.19596345207283, 79.99589566221754, 87.39108710161167, 70.49219171269424, 85.15739701923772, 81.74357262235884, 100.0, 87.17182444898195, 93.10748395447351, 76.98993113358858, 100.0, 93.42822497156905, 81.06359141924727, 100.0, 96.50693828121413, 100.0, 80.96021492117632, 93.93469746157935, 91.31843070850798, 81.15863227339683, 94.87574784401491, 76.66475254680091, 61.92682031605517, 72.83393493230872, 88.09595541940737, 76.59680603490003, 84.92950219052015, 100.0, 88.50632882130958, 100.0, 84.62938446559977, 58.69241468544556, 90.18521918453403, 92.64072353939511, 88.10491735639076, 78.4132711250115, 88.00937915447459, 73.77120271057413, 95.32146215303084, 100.0, 99.09349401032081, 100.0, 79.14173756530198, 90.20308647298943, 95.78112534842123, 61.902042384240545, 100.0, 93.55047193170675, 100.0, 98.44921848034035, 100.0, 47.29389054669778, 81.75358584766377], "diesel_power": [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "electricity_price": [0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4], "weather": [{"irradiance": 0, "temperature": 7.297692056402477, "wind_speed": 7.937325952278009, "cloud_cover": 0.32483570765056163, "humidity": 67.36022051155697}, {"irradiance": 20.21030569613053, "temperature": 4.840558712154062, "wind_speed": 8.00329905701783, "cloud_cover": 0.3387877722605685, "humidity": 57.537784131926315}, {"irradiance": 0, "temperature": 2.5524793151750265, "wind_speed": 9.490817959152913, "cloud_cover": 0.3508858858388702, "humidity": 57.71513892896124}, {"irradiance": 0, "temperature": 4.595627376786277, "wind_speed": 10.673948233415139, "cloud_cover": 0.3294835826300585, "humidity": 49.186404198520556}, {"irradiance": 0, "temperature": 4.913549531150727, "wind_speed": 9.468742252652536, "cloud_cover": 0.33285999286445467, "humidity": 60.54041273448297}, {"irradiance": 18.948796420932776, "temperature": 6.584382982725456, "wind_speed": 8.758257896524112, "cloud_cover": 0.3028473003591591, "humidity": 55.90762030940157}, {"irradiance": 0, "temperature": 7.64740480440747, "wind_speed": 8.345169374668563, "cloud_cover": 0.3021724391222624, "humidity": 52.960954923812764}, {"irradiance": 23.872794485646345, "temperature": 6.439591612308817, "wind_speed": 12.696946969892126, "cloud_cover": 0.4410880911998844, "humidity": 67.64144793073959}, {"irradiance": 0, "temperature": 3.0452709994662372, "wind_speed": 11.127191941835184, "cloud_cover": 0.43530567708047235, "humidity": 59.459949270440625}, {"irradiance": 0, "temperature": 3.7412103708379583, "wind_speed": 10.839043402902778, "cloud_cover": 0.36797177221240507, "humidity": 61.71129757951226}, {"irradiance": 12.233525776817357, "temperature": 8.064314025192994, "wind_speed": 10.548505263440344, "cloud_cover": 0.33412567219710715, "humidity": 64.68017076149421}, {"irradiance": 0, "temperature": 2.9860084011061265, "wind_speed": 7.729412342962882, "cloud_cover": 0.3237673776918784, "humidity": 65.21125620968044}, {"irradiance": 0, "temperature": 7.627366624989488, "wind_speed": 11.962580036156346, "cloud_cover": 0.268450628991577, "humidity": 64.83471901260143}, {"irradiance": 0, "temperature": 7.948242047712667, "wind_speed": 9.245851201124974, "cloud_cover": 0.2165591351658029, "humidity": 60.474751374453795}, {"irradiance": 31.292873116280123, "temperature": 0.7628247720216033, "wind_speed": 7.6495717593335435, "cloud_cover": 0.21476783321030535, "humidity": 60.55254751818528}, {"irradiance": 20.849832346788418, "temperature": 7.809379961452777, "wind_speed": 8.171553857319912, "cloud_cover": 0.1438303102807352, "humidity": 54.409910963732806}, {"irradiance": 0, "temperature": 4.3853277744147166, "wind_speed": 12.907976383114566, "cloud_cover": 0.217725012517811, "humidity": 54.022965157611644}, {"irradiance": 23.163733058640553, "temperature": 6.516548720313651, "wind_speed": 8.011067164070594, "cloud_cover": 0.24279742909405128, "humidity": 58.85648735213739}, {"irradiance": 19.372899810657785, "temperature": 4.598208792446387, "wind_speed": 8.115449703632079, "cloud_cover": 0.2476513065614533, "humidity": 55.79122846385476}, {"irradiance": 0, "temperature": 0.6919628850741519, "wind_speed": 8.100410887904966, "cloud_cover": 0.3113379875684311, "humidity": 61.06772934649677}, {"irradiance": 0, "temperature": 5.679743556869074, "wind_speed": 9.06098182287362, "cloud_cover": 0.29420226174209263, "humidity": 60.84632213633547}, {"irradiance": 28.07917477318587, "temperature": 5.9652133711778115, "wind_speed": 8.313937131511409, "cloud_cover": 0.2470494213187295, "humidity": 49.04395952961077}, {"irradiance": 49.26484224970572, "temperature": 5.617593050638847, "wind_speed": 7.911137933324255, "cloud_cover": 0.2500609318157808, "humidity": 59.009564666141486}, {"irradiance": 0, "temperature": 7.5369086576139, "wind_speed": 10.46585146383224, "cloud_cover": 0.267051980025113, "humidity": 52.2625965132816}, {"irradiance": 0, "temperature": 8.80790360207329, "wind_speed": 9.605751865628593, "cloud_cover": 0.30660357737726535, "humidity": 52.18885200735656}, {"irradiance": 1.5378989716914284, "temperature": 5.015450015794439, "wind_speed": 8.01094042456843, "cloud_cover": 0.2625715364507769, "humidity": 62.49295913523307}, {"irradiance": 0, "temperature": 2.9009881180688266, "wind_speed": 9.6703248944487, "cloud_cover": 0.26755410470515895, "humidity": 58.36943801518491}, {"irradiance": 0, "temperature": 7.243411412124562, "wind_speed": 7.893965038231874, "cloud_cover": 0.2943709063242622, "humidity": 58.02644030541255}, {"irradiance": 0, "temperature": 7.629349414940432, "wind_speed": 10.997044356631758, "cloud_cover": 0.2552082417074504, "humidity": 51.50192566905373}, {"irradiance": 50.78325432538665, "temperature": 5.353333064543305, "wind_speed": 12.148322661742363, "cloud_cover": 0.32340256792830563, "humidity": 58.67274345237164}, {"irradiance": 15.636457435546207, "temperature": 3.528413558444928, "wind_speed": 10.187007070807553, "cloud_cover": 0.3363967076407268, "humidity": 53.48961816380042}, {"irradiance": 24.341415939602204, "temperature": 6.454891519198842, "wind_speed": 7.6165554225753045, "cloud_cover": 0.36727874991628406, "humidity": 65.25536966037171}, {"irradiance": 0, "temperature": 9.733864002490606, "wind_speed": 9.708959175623814, "cloud_cover": 0.3819323735812181, "humidity": 63.82713581199548}, {"irradiance": 0, "temperature": 4.499956130873235, "wind_speed": 10.342791314684897, "cloud_cover": 0.4186574268252204, "humidity": 56.90758253915396}, {"irradiance": 8.255618538729966, "temperature": 7.646435300190072, "wind_speed": 7.794790334250137, "cloud_cover": 0.4668262332874365, "humidity": 73.48875191189282}, {"irradiance": 0, "temperature": 7.759662076582884, "wind_speed": 9.592744982826282, "cloud_cover": 0.3983326804516217, "humidity": 60.752007872579604}, {"irradiance": 29.070681543146335, "temperature": 5.47300131372518, "wind_speed": 8.032506002003792, "cloud_cover": 0.39898277504551705, "humidity": 75.5703290843136}, {"irradiance": 19.543600016261465, "temperature": 6.086275109141138, "wind_speed": 7.9879433518029614, "cloud_cover": 0.35083199374221075, "humidity": 59.838600726777244}, {"irradiance": 14.28000988184184, "temperature": 6.948790229348182, "wind_speed": 14.225547163613726, "cloud_cover": 0.3396588544759182, "humidity": 59.825621070993186}, {"irradiance": 15.540995898072158, "temperature": 8.093457316893726, "wind_speed": 8.360368674214751, "cloud_cover": 0.31703574285868474, "humidity": 57.800363722733636}, {"irradiance": 0, "temperature": 6.348676831903456, "wind_speed": 9.286300884224627, "cloud_cover": 0.32774043006519493, "humidity": 61.75879980060003}, {"irradiance": 0, "temperature": 8.117161997925844, "wind_speed": 10.298144708060656, "cloud_cover": 0.3392881162124516, "humidity": 60.43544778377172}, {"irradiance": 21.07604104069806, "temperature": 3.24697624428691, "wind_speed": 10.91282522587274, "cloud_cover": 0.39344067837121544, "humidity": 57.114095151560846}, {"irradiance": 5.144149819602136, "temperature": 6.050178609132766, "wind_speed": 8.990444966455714, "cloud_cover": 0.40866313436475804, "humidity": 66.6194639750047}, {"irradiance": 22.71131280361198, "temperature": 7.910318507187497, "wind_speed": 12.01272316404685, "cloud_cover": 0.4372076598994164, "humidity": 66.37318605351149}, {"irradiance": 0, "temperature": 6.332360576419769, "wind_speed": 7.67128441977503, "cloud_cover": 0.37957939131641566, "humidity": 57.10773715034563}, {"irradiance": 0, "temperature": 7.374835360950119, "wind_speed": 7.660026335556265, "cloud_cover": 0.4953123196500911, "humidity": 56.79579023355448}, {"irradiance": 0, "temperature": 9.12307526246685, "wind_speed": 8.084312218213123, "cloud_cover": 0.45065630596862993, "humidity": 64.16244417941431}, {"irradiance": 4.329171791639498, "temperature": 6.09345866000872, "wind_speed": 9.153897096742801, "cloud_cover": 0.4141379743827731, "humidity": 59.16613749345411}, {"irradiance": 16.575319552097497, "temperature": 6.03260153672082, "wind_speed": 8.378115639565273, "cloud_cover": 0.48230974893035833, "humidity": 66.67966255224441}, {"irradiance": 17.048666695924478, "temperature": 4.417273503335691, "wind_speed": 7.649431430436265, "cloud_cover": 0.44922042569193893, "humidity": 62.90293056342367}, {"irradiance": 33.22603461216308, "temperature": 7.263268437080191, "wind_speed": 8.473789457120372, "cloud_cover": 0.41062947180410114, "humidity": 60.72964962157012}, {"irradiance": 8.09963421921911, "temperature": 5.409994710710835, "wind_speed": 14.093984475979818, "cloud_cover": 0.498902183818156, "humidity": 69.55637524981857}, {"irradiance": 33.027019729589796, "temperature": 5.278099087109132, "wind_speed": 8.467100063415332, "cloud_cover": 0.5177669970911765, "humidity": 74.75158890149453}, {"irradiance": 0, "temperature": 8.819401475673383, "wind_speed": 9.18334666769299, "cloud_cover": 0.5811125545505076, "humidity": 71.30654690366191}, {"irradiance": 0, "temperature": 5.341877670421207, "wind_speed": 9.035575741471852, "cloud_cover": 0.5801404475055302, "humidity": 66.87862090143383}, {"irradiance": 0, "temperature": 7.051673645986958, "wind_speed": 8.836545488177329, "cloud_cover": 0.661761012702112, "humidity": 70.50653326749381}, {"irradiance": 46.959938569006454, "temperature": 8.741713636921975, "wind_speed": 8.25348321640182, "cloud_cover": 0.6646864578174542, "humidity": 74.4892846093227}, {"irradiance": 0, "temperature": 8.071366789360964, "wind_speed": 13.532288389641508, "cloud_cover": 0.6746394425961276, "humidity": 68.31261529357502}, {"irradiance": 25.610815233549275, "temperature": 6.7014952638382645, "wind_speed": 9.475406200019846, "cloud_cover": 0.5797705934716948, "humidity": 77.9497060122321}], "total_cost": [0.6666666666666666, 1.3143211945636721, 1.7686094149711704, 2.173086530406669, 2.8397531970733354, 3.506419863740002, 4.173086530406668, 4.421059620087154, 4.954365591168604, 5.536972838512682, 6.006920783263977, 6.5746367633922285, 7.119593914207954, 7.786260580874621, 8.367406077201167, 8.988122636897657, 9.501388844454913, 10.16805551112158, 10.790910344265374, 11.331334287060356, 11.998000953727022, 12.64138054226845, 13.308047208935117, 13.847781975076291, 14.47401329148682, 15.082802829543539, 15.623860378032852, 16.25636536365962, 16.767463713971626, 17.180309182745326, 17.66586874896072, 18.253175118423435, 18.763820491989435, 19.33001717325957, 19.996683839926238, 20.586726032068302, 21.25339269873497, 21.817588595172303, 22.20887135974194, 22.8101061543055, 23.42771097790147, 24.015077093610742, 24.537832234444153, 25.12456142880732, 25.616369446877812, 26.251845861231352, 26.91851252789802, 27.57913582130016, 28.245802487966827, 28.77341407173551, 29.37476798155544, 30.01330881721158, 30.425989099773183, 31.09265576643985, 31.716325579317896, 32.38299224598456, 33.03932036918683, 33.7059870358535, 34.02127963949815, 34.56630354514924], "renewable_ratio": [0.07147663762416223, 0.08427988145161454, 0.1211464257201196, 0.17065419314980368, 0.16255644185717277, 0.1549230239628476, 0.14573541589818204, 0.19130416598642877, 0.2060940054247871, 0.2135736994711409, 0.22113082778624338, 0.21093340553820164, 0.22619112628032945, 0.21803031414955282, 0.21124569176124075, 0.20520439308385083, 0.21792365321695678, 0.21039633381288486, 0.20521131095159592, 0.20092961925846384, 0.1974882151361865, 0.1939289165338556, 0.18992961271413472, 0.19285250610142474, 0.1920714655452975, 0.1884229498144067, 0.1888371369652174, 0.18512268554459954, 0.18964916492550343, 0.19959002583163835, 0.2016706357939572, 0.19866479923168, 0.19904903019143144, 0.2003571291262556, 0.19617909259911243, 0.19578107012382237, 0.19254528506180438, 0.19064455662730512, 0.19777329300387025, 0.1959033899495979, 0.19490949563938165, 0.19584456926376811, 0.19874111478375578, 0.1976433217861429, 0.2031743676327728, 0.20043498119215333, 0.1971486576782055, 0.19481200732499804, 0.192800896271095, 0.1918270991151335, 0.18996961163103, 0.1888318728350101, 0.1939048108497628, 0.1920098875370031, 0.19120755401997452, 0.1897980539442026, 0.18858493534429294, 0.18721137985392952, 0.1920894725075743, 0.19229192836903775]};
        
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let solarPanels = [], windTurbines = [], batterySystem, loadCenter, gridConnection;
        let powerFlowParticles = [];
        let isSimulating = false;
        let simulationSpeed = 1;
        let dieselOn = false;
        let autoMode = true;
        
        // ç‚¹å‡»äº¤äº’
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let clickableObjects = new Map();
        let currentDetailComponent = null;
        
        // ç­–ç•¥æ•°æ®
        let strategyData = {
            current: 'adaptive',
            rl_confidence: 0.5,
            epsilon: 1.0,
            training_steps: 0,
            buffer_size: 0,
            recent_performance: 0,
            current_action: { battery_action: 0, diesel_on: false }
        };
        
        let comparisonData = {
            rl: { cost: 0, renewable: 0, rank: 0 },
            rule: { cost: 0, renewable: 0, rank: 0 },
            random: { cost: 0, renewable: 0, rank: 0 }
        };
        
        // æ¨¡æ‹Ÿå‘¨æœŸï¼šä¸€ä¸ªæœˆï¼ˆ30å¤©ï¼‰
        const SIMULATION_DAYS = 30;
        const STEPS_PER_MINUTE = 1;
        const TOTAL_STEPS = SIMULATION_DAYS * 24 * 60; // 43200æ­¥
        let currentStep = 0;
        
        // åˆå§‹åŒ–Three.jsåœºæ™¯
        function initScene() {
            const container = document.getElementById('canvas-container');
            
            // åœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1628);
            scene.fog = new THREE.Fog(0x0a1628, 100, 500);
            
            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(80, 60, 80);
            
            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 30;
            controls.maxDistance = 200;
            controls.maxPolarAngle = Math.PI / 2.1;
            
            // å…‰ç…§
            setupLighting();
            
            // åˆ›å»ºåœ°é¢å’Œç¯å¢ƒ
            createEnvironment();
            
            // åˆ›å»ºå¾®ç½‘ç»„ä»¶
            createMicrogridComponents();
            
            // åˆ›å»ºç”µåŠ›æµåŠ¨ç²’å­
            createPowerFlowSystem();
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            renderer.domElement.addEventListener('click', onMouseClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
        }
        
        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        function onMouseClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                const component = findComponentByObject(clickedObject);
                
                if (component) {
                    showDetailModal(component);
                }
            }
        }
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆæ˜¾ç¤ºæç¤ºï¼‰
        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            const hint = document.getElementById('click-hint');
            if (intersects.length > 0) {
                const hoveredObject = intersects[0].object;
                const component = findComponentByObject(hoveredObject);
                
                if (component) {
                    hint.textContent = `ç‚¹å‡»æŸ¥çœ‹ ${component.name} è¯¦æƒ…`;
                    hint.style.left = event.clientX + 10 + 'px';
                    hint.style.top = event.clientY + 10 + 'px';
                    hint.classList.add('show');
                    renderer.domElement.style.cursor = 'pointer';
                } else {
                    hint.classList.remove('show');
                    renderer.domElement.style.cursor = 'default';
                }
            } else {
                hint.classList.remove('show');
                renderer.domElement.style.cursor = 'default';
            }
        }
        
        // æŸ¥æ‰¾ç»„ä»¶
        function findComponentByObject(obj) {
            let current = obj;
            while (current) {
                if (current.userData && current.userData.componentType) {
                    return {
                        type: current.userData.componentType,
                        name: current.userData.componentName || current.userData.componentType,
                        object: current
                    };
                }
                current = current.parent;
            }
            return null;
        }
        
        // æ˜¾ç¤ºè¯¦ç»†ç•Œé¢
        function showDetailModal(component) {
            currentDetailComponent = component;
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('detail-title');
            const body = document.getElementById('detail-body');
            
            title.textContent = component.name + ' - è¯¦ç»†ä¿¡æ¯';
            
            // è·å–å½“å‰çŠ¶æ€
            const state = systemState || getCurrentState();
            let html = '';
            
            switch(component.type) {
                case 'solar':
                    html = generateSolarDetail(state);
                    break;
                case 'wind':
                    html = generateWindDetail(state);
                    break;
                case 'battery':
                    html = generateBatteryDetail(state);
                    break;
                case 'load':
                    html = generateLoadDetail(state);
                    break;
                case 'grid':
                    html = generateGridDetail(state);
                    break;
                default:
                    html = '<p>æš‚æ— è¯¦ç»†ä¿¡æ¯</p>';
            }
            
            body.innerHTML = html;
            modal.classList.add('active');
        }
        
        // å…³é—­è¯¦ç»†ç•Œé¢
        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
            currentDetailComponent = null;
        }
        
        // ç”Ÿæˆå„ç»„ä»¶è¯¦ç»†ä¿¡æ¯
        function generateSolarDetail(state) {
            const solar = state.components?.solar || {};
            return `
                <div class="detail-info">
                    <div class="detail-item">
                        <div class="detail-label">è£…æœºå®¹é‡</div>
                        <div class="detail-value">${solar.capacity || 100} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å½“å‰åŠŸç‡</div>
                        <div class="detail-value">${(solar.current_power || 0).toFixed(2)} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">åˆ©ç”¨ç‡</div>
                        <div class="detail-value">${((solar.current_power || 0) / (solar.capacity || 100) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å¤ªé˜³è¾ç…§åº¦</div>
                        <div class="detail-value">${(state.weather?.irradiance || 0).toFixed(0)} W/mÂ²</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ç¯å¢ƒæ¸©åº¦</div>
                        <div class="detail-value">${(state.weather?.temperature || 0).toFixed(1)} Â°C</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">äº‘å±‚è¦†ç›–</div>
                        <div class="detail-value">${((state.weather?.cloud_cover || 0) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }
        
        function generateWindDetail(state) {
            const wind = state.components?.wind || {};
            return `
                <div class="detail-info">
                    <div class="detail-item">
                        <div class="detail-label">è£…æœºå®¹é‡</div>
                        <div class="detail-value">${wind.capacity || 50} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å½“å‰åŠŸç‡</div>
                        <div class="detail-value">${(wind.current_power || 0).toFixed(2)} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">åˆ©ç”¨ç‡</div>
                        <div class="detail-value">${((wind.current_power || 0) / (wind.capacity || 50) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é£é€Ÿ</div>
                        <div class="detail-value">${(state.weather?.wind_speed || 0).toFixed(1)} m/s</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é£æœºæ•°é‡</div>
                        <div class="detail-value">2 å°</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¿è¡ŒçŠ¶æ€</div>
                        <div class="detail-value">æ­£å¸¸</div>
                    </div>
                </div>
            `;
        }
        
        function generateBatteryDetail(state) {
            const battery = state.components?.battery || {};
            return `
                <div class="detail-info">
                    <div class="detail-item">
                        <div class="detail-label">å®¹é‡</div>
                        <div class="detail-value">${battery.capacity || 200} kWh</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å½“å‰SOC</div>
                        <div class="detail-value">${((battery.soc || 0.5) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å¥åº·åº¦</div>
                        <div class="detail-value">${((battery.health || 1.0) * 100).toFixed(1)}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å‰©ä½™å®¹é‡</div>
                        <div class="detail-value">${((battery.soc || 0.5) * (battery.capacity || 200)).toFixed(1)} kWh</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ€å¤§å……ç”µåŠŸç‡</div>
                        <div class="detail-value">50 kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ€å¤§æ”¾ç”µåŠŸç‡</div>
                        <div class="detail-value">50 kW</div>
                    </div>
                </div>
            `;
        }
        
        function generateLoadDetail(state) {
            const load = state.components?.load || {};
            return `
                <div class="detail-info">
                    <div class="detail-item">
                        <div class="detail-label">å½“å‰è´Ÿè·</div>
                        <div class="detail-value">${(load.current || 0).toFixed(2)} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">åŸºç¡€è´Ÿè·</div>
                        <div class="detail-value">${load.base || 80} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å³°å€¼è´Ÿè·</div>
                        <div class="detail-value">${load.peak || 150} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è´Ÿè·ç‡</div>
                        <div class="detail-value">${((load.current || 0) / (load.peak || 150) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }
        
        function generateGridDetail(state) {
            const grid = state.components?.grid || {};
            return `
                <div class="detail-info">
                    <div class="detail-item">
                        <div class="detail-label">è¿æ¥çŠ¶æ€</div>
                        <div class="detail-value">${grid.connected ? 'å·²è¿æ¥' : 'æ–­å¼€'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ€å¤§è´­ç”µåŠŸç‡</div>
                        <div class="detail-value">${grid.max_import || 100} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ€å¤§å”®ç”µåŠŸç‡</div>
                        <div class="detail-value">${grid.max_export || 50} kW</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è´­ç”µä»·æ ¼</div>
                        <div class="detail-value">Â¥${(state.price?.buy_price || 0.8).toFixed(2)}/kWh</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å”®ç”µä»·æ ¼</div>
                        <div class="detail-value">Â¥${(state.price?.sell_price || 0.56).toFixed(2)}/kWh</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æ—¶æ®µç±»å‹</div>
                        <div class="detail-value">${state.price?.period || 'normal'}</div>
                    </div>
                </div>
            `;
        }
        
        function getCurrentState() {
            return systemState || {
                components: {},
                weather: {},
                price: {}
            };
        }
        
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404060, 0.5);
            scene.add(ambientLight);
            
            // ä¸»å…‰æºï¼ˆå¤ªé˜³ï¼‰
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 500;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            scene.add(sunLight);
            
            // è¡¥å…‰
            const fillLight = new THREE.DirectionalLight(0x4080ff, 0.3);
            fillLight.position.set(-50, 50, -50);
            scene.add(fillLight);
            
            // ç‚¹å…‰æºï¼ˆè£…é¥°ï¼‰
            const pointLight1 = new THREE.PointLight(0x00d4ff, 0.5, 100);
            pointLight1.position.set(0, 30, 0);
            scene.add(pointLight1);
        }
        
        function createEnvironment() {
            // åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(300, 300);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x1a2a3a,
                roughness: 0.9,
                metalness: 0.1
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // ç½‘æ ¼çº¿
            const gridHelper = new THREE.GridHelper(300, 30, 0x1e3a5f, 0x1e3a5f);
            gridHelper.position.y = 0.01;
            scene.add(gridHelper);
            
            // æ·»åŠ è£…é¥°æ€§åœ†ç¯
            const ringGeometry = new THREE.RingGeometry(40, 42, 64);
            const ringMaterial = new THREE.MeshBasicMaterial({
                color: 0x00d4ff,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.rotation.x = -Math.PI / 2;
            ring.position.y = 0.02;
            scene.add(ring);
        }
        
        function createMicrogridComponents() {
            // å…‰ä¼é˜µåˆ—
            createSolarPanels();
            
            // é£åŠ›å‘ç”µæœº
            createWindTurbines();
            
            // å‚¨èƒ½ç”µæ± 
            createBatterySystem();
            
            // è´Ÿè·ä¸­å¿ƒ
            createLoadCenter();
            
            // ç”µç½‘è¿æ¥
            createGridConnection();
            
            // æ§åˆ¶ä¸­å¿ƒ
            createControlCenter();
            
            // è¿æ¥çº¿
            createConnectionLines();
        }
        
        function createSolarPanels() {
            const panelGroup = new THREE.Group();
            
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 3; j++) {
                    const panelGeometry = new THREE.BoxGeometry(8, 0.3, 5);
                    const panelMaterial = new THREE.MeshStandardMaterial({
                        color: 0x1a3c5c,
                        roughness: 0.3,
                        metalness: 0.8
                    });
                    const panel = new THREE.Mesh(panelGeometry, panelMaterial);
                    panel.position.set(-40 + i * 10, 4, -30 + j * 8);
                    panel.rotation.x = -Math.PI / 6;
                    panel.castShadow = true;
                    panel.receiveShadow = true;
                    
                    // æ”¯æ¶
                    const poleGeometry = new THREE.CylinderGeometry(0.2, 0.2, 4);
                    const poleMaterial = new THREE.MeshStandardMaterial({ color: 0x666666 });
                    const pole = new THREE.Mesh(poleGeometry, poleMaterial);
                    pole.position.set(-40 + i * 10, 2, -30 + j * 8);
                    
                    panelGroup.add(panel);
                    panelGroup.add(pole);
                    solarPanels.push(panel);
                }
            }
            
            // æ·»åŠ ç»„ä»¶æ ‡è¯†
            panelGroup.userData = {
                componentType: 'solar',
                componentName: 'å…‰ä¼é˜µåˆ—'
            };
            
            // å…‰ä¼æ ‡ç­¾
            const labelSprite = createLabel('â˜€ï¸ å…‰ä¼é˜µåˆ—\n100 kW', 0xf1c40f);
            labelSprite.position.set(-25, 15, -22);
            panelGroup.add(labelSprite);
            
            scene.add(panelGroup);
        }
        
        function createWindTurbines() {
            for (let i = 0; i < 2; i++) {
                const turbineGroup = new THREE.Group();
                
                // å¡”ç­’
                const towerGeometry = new THREE.CylinderGeometry(1, 2, 30, 8);
                const towerMaterial = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
                const tower = new THREE.Mesh(towerGeometry, towerMaterial);
                tower.position.y = 15;
                tower.castShadow = true;
                turbineGroup.add(tower);
                
                // æœºèˆ±
                const nacelleGeometry = new THREE.BoxGeometry(6, 3, 3);
                const nacelleMaterial = new THREE.MeshStandardMaterial({ color: 0xdddddd });
                const nacelle = new THREE.Mesh(nacelleGeometry, nacelleMaterial);
                nacelle.position.y = 31;
                nacelle.castShadow = true;
                turbineGroup.add(nacelle);
                
                // å¶ç‰‡
                const bladesGroup = new THREE.Group();
                for (let b = 0; b < 3; b++) {
                    const bladeGeometry = new THREE.BoxGeometry(0.5, 12, 1);
                    const bladeMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
                    const blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
                    blade.position.y = 6;
                    blade.rotation.z = (b * Math.PI * 2) / 3;
                    blade.castShadow = true;
                    bladesGroup.add(blade);
                }
                bladesGroup.position.set(3, 31, 0);
                turbineGroup.add(bladesGroup);
                turbineGroup.bladesGroup = bladesGroup;
                
                turbineGroup.position.set(40 + i * 25, 0, -30);
                turbineGroup.userData = {
                    componentType: 'wind',
                    componentName: 'é£åŠ›å‘ç”µ'
                };
                scene.add(turbineGroup);
                windTurbines.push(turbineGroup);
            }
            
            // é£æœºæ ‡ç­¾
            const labelSprite = createLabel('ğŸ’¨ é£åŠ›å‘ç”µ\n50 kW', 0x3498db);
            labelSprite.position.set(52, 45, -30);
            scene.add(labelSprite);
        }
        
        function createBatterySystem() {
            batterySystem = new THREE.Group();
            
            // ç”µæ± æŸœ
            for (let i = 0; i < 3; i++) {
                const cabinetGeometry = new THREE.BoxGeometry(6, 10, 4);
                const cabinetMaterial = new THREE.MeshStandardMaterial({
                    color: 0x27ae60,
                    roughness: 0.5,
                    metalness: 0.5
                });
                const cabinet = new THREE.Mesh(cabinetGeometry, cabinetMaterial);
                cabinet.position.set(-5 + i * 8, 5, 35);
                cabinet.castShadow = true;
                batterySystem.add(cabinet);
                
                // ç”µé‡æŒ‡ç¤ºç¯
                const lightGeometry = new THREE.BoxGeometry(4, 0.5, 0.1);
                const lightMaterial = new THREE.MeshBasicMaterial({ color: 0x2ecc71 });
                const light = new THREE.Mesh(lightGeometry, lightMaterial);
                light.position.set(-5 + i * 8, 8, 37.1);
                batterySystem.add(light);
            }
            
            // åº•åº§
            const baseGeometry = new THREE.BoxGeometry(30, 1, 8);
            const baseMaterial = new THREE.MeshStandardMaterial({ color: 0x444444 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.set(3, 0.5, 35);
            batterySystem.add(base);
            
            // æ ‡ç­¾
            const labelSprite = createLabel('ğŸ”‹ å‚¨èƒ½ç³»ç»Ÿ\n200 kWh', 0x2ecc71);
            labelSprite.position.set(3, 18, 35);
            batterySystem.add(labelSprite);
            
            // æ·»åŠ ç»„ä»¶æ ‡è¯†
            batterySystem.userData = {
                componentType: 'battery',
                componentName: 'å‚¨èƒ½ç³»ç»Ÿ'
            };
            
            scene.add(batterySystem);
        }
        
        function createLoadCenter() {
            loadCenter = new THREE.Group();
            
            // ä¸»å»ºç­‘
            const buildingGeometry = new THREE.BoxGeometry(20, 15, 15);
            const buildingMaterial = new THREE.MeshStandardMaterial({
                color: 0x34495e,
                roughness: 0.7,
                metalness: 0.3
            });
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
            building.position.y = 7.5;
            building.castShadow = true;
            building.receiveShadow = true;
            loadCenter.add(building);
            
            // çª—æˆ·
            for (let floor = 0; floor < 2; floor++) {
                for (let win = 0; win < 3; win++) {
                    const windowGeometry = new THREE.PlaneGeometry(3, 3);
                    const windowMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffdd88,
                        transparent: true,
                        opacity: 0.8
                    });
                    const window = new THREE.Mesh(windowGeometry, windowMaterial);
                    window.position.set(-6 + win * 6, 4 + floor * 5, 7.6);
                    loadCenter.add(window);
                }
            }
            
            // å±‹é¡¶
            const roofGeometry = new THREE.BoxGeometry(22, 2, 17);
            const roofMaterial = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            const roof = new THREE.Mesh(roofGeometry, roofMaterial);
            roof.position.y = 16;
            loadCenter.add(roof);
            
            loadCenter.position.set(0, 0, 0);
            
            // æ ‡ç­¾
            const labelSprite = createLabel('ğŸ­ è´Ÿè·ä¸­å¿ƒ\n150 kWå³°å€¼', 0xe74c3c);
            labelSprite.position.set(0, 25, 0);
            loadCenter.add(labelSprite);
            
            // æ·»åŠ ç»„ä»¶æ ‡è¯†
            loadCenter.userData = {
                componentType: 'load',
                componentName: 'è´Ÿè·ä¸­å¿ƒ'
            };
            
            scene.add(loadCenter);
        }
        
        function createGridConnection() {
            gridConnection = new THREE.Group();
            
            // å˜ç”µç«™
            const stationGeometry = new THREE.BoxGeometry(8, 12, 8);
            const stationMaterial = new THREE.MeshStandardMaterial({
                color: 0x8e44ad,
                roughness: 0.6,
                metalness: 0.4
            });
            const station = new THREE.Mesh(stationGeometry, stationMaterial);
            station.position.y = 6;
            station.castShadow = true;
            gridConnection.add(station);
            
            // é«˜å‹çº¿å¡”
            const poleGeometry = new THREE.CylinderGeometry(0.3, 0.5, 25, 6);
            const poleMaterial = new THREE.MeshStandardMaterial({ color: 0x666666 });
            const pole = new THREE.Mesh(poleGeometry, poleMaterial);
            pole.position.set(0, 12.5, -10);
            gridConnection.add(pole);
            
            // æ¨ªæ¢
            const crossbarGeometry = new THREE.BoxGeometry(12, 0.5, 0.5);
            const crossbar = new THREE.Mesh(crossbarGeometry, poleMaterial);
            crossbar.position.set(0, 23, -10);
            gridConnection.add(crossbar);
            
            gridConnection.position.set(60, 0, 30);
            
            // æ ‡ç­¾
            const labelSprite = createLabel('âš¡ ç”µç½‘è¿æ¥\n100kWè¿›/50kWå‡º', 0x9b59b6);
            labelSprite.position.set(0, 30, -5);
            gridConnection.add(labelSprite);
            
            // æ·»åŠ ç»„ä»¶æ ‡è¯†
            gridConnection.userData = {
                componentType: 'grid',
                componentName: 'ç”µç½‘è¿æ¥'
            };
            
            scene.add(gridConnection);
        }
        
        function createControlCenter() {
            const controlGroup = new THREE.Group();
            
            // æ§åˆ¶å®¤
            const roomGeometry = new THREE.BoxGeometry(10, 8, 10);
            const roomMaterial = new THREE.MeshStandardMaterial({
                color: 0x2980b9,
                roughness: 0.5,
                metalness: 0.5
            });
            const room = new THREE.Mesh(roomGeometry, roomMaterial);
            room.position.y = 4;
            room.castShadow = true;
            controlGroup.add(room);
            
            // å¤©çº¿
            const antennaGeometry = new THREE.CylinderGeometry(0.1, 0.1, 8);
            const antennaMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc });
            const antenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
            antenna.position.set(0, 12, 0);
            controlGroup.add(antenna);
            
            // ä¿¡å·çƒ
            const ballGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const ballMaterial = new THREE.MeshBasicMaterial({ color: 0x00d4ff });
            const ball = new THREE.Mesh(ballGeometry, ballMaterial);
            ball.position.set(0, 16, 0);
            controlGroup.add(ball);
            
            controlGroup.position.set(-50, 0, 30);
            
            const labelSprite = createLabel('ğŸ›ï¸ æ§åˆ¶ä¸­å¿ƒ', 0x00d4ff);
            labelSprite.position.set(0, 20, 0);
            controlGroup.add(labelSprite);
            
            scene.add(controlGroup);
        }
        
        function createLabel(text, color) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 128;
            
            context.fillStyle = 'rgba(0, 0, 0, 0.7)';
            context.beginPath();
            context.roundRect(0, 0, 256, 128, 15);
            context.fill();
            
            context.strokeStyle = '#' + color.toString(16).padStart(6, '0');
            context.lineWidth = 2;
            context.beginPath();
            context.roundRect(2, 2, 252, 124, 13);
            context.stroke();
            
            context.fillStyle = '#ffffff';
            context.font = 'bold 20px Arial';
            context.textAlign = 'center';
            
            const lines = text.split('\n');
            lines.forEach((line, i) => {
                context.fillText(line, 128, 50 + i * 30);
            });
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({
                map: texture,
                transparent: true
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(15, 7.5, 1);
            
            return sprite;
        }
        
        function createConnectionLines() {
            const lineMaterial = new THREE.LineBasicMaterial({
                color: 0x00d4ff,
                transparent: true,
                opacity: 0.5
            });
            
            const connections = [
                [[-25, 2, -22], [0, 2, 0]],  // å…‰ä¼åˆ°è´Ÿè·
                [[52, 2, -30], [0, 2, 0]],   // é£æœºåˆ°è´Ÿè·
                [[3, 2, 35], [0, 2, 0]],     // ç”µæ± åˆ°è´Ÿè·
                [[0, 2, 0], [60, 2, 30]],    // è´Ÿè·åˆ°ç”µç½‘
                [[-50, 2, 30], [0, 2, 0]]    // æ§åˆ¶ä¸­å¿ƒåˆ°è´Ÿè·
            ];
            
            connections.forEach(conn => {
                const points = [
                    new THREE.Vector3(...conn[0]),
                    new THREE.Vector3(...conn[1])
                ];
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(geometry, lineMaterial);
                scene.add(line);
            });
        }
        
        function createPowerFlowSystem() {
            // åˆ›å»ºç²’å­ç³»ç»Ÿè¡¨ç¤ºç”µåŠ›æµåŠ¨
            const particleCount = 100;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 100;
                positions[i * 3 + 1] = Math.random() * 2 + 1;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 100;
                
                colors[i * 3] = 0;
                colors[i * 3 + 1] = 0.8;
                colors[i * 3 + 2] = 1;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8
            });
            
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
            powerFlowParticles.push({ points: particles, positions: positions });
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();
            
            // é£æœºå¶ç‰‡æ—‹è½¬
            windTurbines.forEach(turbine => {
                if (turbine.bladesGroup) {
                    turbine.bladesGroup.rotation.x += 0.02 * simulationSpeed;
                }
            });
            
            // ç”µåŠ›æµåŠ¨ç²’å­åŠ¨ç”»
            powerFlowParticles.forEach(system => {
                const positions = system.points.geometry.attributes.position.array;
                for (let i = 0; i < positions.length / 3; i++) {
                    positions[i * 3 + 1] += 0.05;
                    if (positions[i * 3 + 1] > 5) {
                        positions[i * 3 + 1] = 1;
                    }
                }
                system.points.geometry.attributes.position.needsUpdate = true;
            });
            
            // ç”µæ± å‘¼å¸ç¯æ•ˆæœ
            if (batterySystem) {
                const pulse = Math.sin(Date.now() * 0.003) * 0.2 + 0.8;
                batterySystem.children.forEach(child => {
                    if (child.material && child.material.emissive) {
                        child.material.emissiveIntensity = pulse;
                    }
                });
            }
            
            renderer.render(scene, camera);
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        function updateDisplay(state) {
            if (!state || !state.components) return;
            
            const components = state.components;
            const weather = state.weather || {};
            const price = state.price || {};
            const stats = state.statistics || {};
            
            // æ›´æ–°çŠ¶æ€é¢æ¿
            document.getElementById('solar-power').textContent = 
                (components.solar?.current_power || 0).toFixed(1) + ' kW';
            document.getElementById('solar-bar').style.width = 
                ((components.solar?.current_power || 0) / 100 * 100) + '%';
            
            document.getElementById('wind-power').textContent = 
                (components.wind?.current_power || 0).toFixed(1) + ' kW';
            document.getElementById('wind-bar').style.width = 
                ((components.wind?.current_power || 0) / 50 * 100) + '%';
            
            const soc = (components.battery?.soc || 0.5) * 100;
            document.getElementById('battery-soc').textContent = soc.toFixed(1) + '%';
            document.getElementById('battery-bar').style.width = soc + '%';
            
            const socElement = document.getElementById('battery-soc');
            socElement.className = 'status-value ' + 
                (soc < 20 ? 'danger' : soc < 40 ? 'warning' : 'good');
            
            document.getElementById('load-power').textContent = 
                (components.load?.current || 0).toFixed(1) + ' kW';
            document.getElementById('load-bar').style.width = 
                ((components.load?.current || 0) / 150 * 100) + '%';
            
            document.getElementById('price').textContent = 
                'Â¥' + (price.buy_price || 0.8).toFixed(2) + '/kWh';
            
            document.getElementById('temperature').textContent = 
                (weather.temperature || 20).toFixed(1) + 'Â°C';
            
            const renewableRatio = (stats.renewable_ratio || 0) * 100;
            document.getElementById('renewable-ratio').textContent = 
                renewableRatio.toFixed(1) + '%';
            
            // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
            document.getElementById('total-cost').textContent = 
                'Â¥' + (stats.total_cost || 0).toFixed(2);
            document.getElementById('total-energy').textContent = 
                (stats.total_renewable_energy || 0).toFixed(1) + ' kWh';
            document.getElementById('co2-saved').textContent = 
                ((stats.total_renewable_energy || 0) * 0.5).toFixed(1) + ' kg';
            document.getElementById('efficiency').textContent = 
                renewableRatio.toFixed(0) + '%';
            
            // æ›´æ–°æ—¶é—´
            if (state.timestamp) {
                const date = new Date(state.timestamp);
                document.getElementById('time-display').textContent = 
                    date.toLocaleString('zh-CN');
            }
        }
        
        // ç®€å•å›¾è¡¨ç»˜åˆ¶
        function drawChart(history) {
            const canvas = document.getElementById('power-chart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.parentElement.clientWidth - 30;
            canvas.height = canvas.parentElement.clientHeight - 30;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, 10);
            ctx.lineTo(40, canvas.height - 20);
            ctx.lineTo(canvas.width - 10, canvas.height - 20);
            ctx.stroke();
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#00d4ff';
            ctx.font = '14px Arial';
            ctx.fillText('åŠŸç‡è¶‹åŠ¿å›¾ (kW)', 50, 20);
            
            if (!history || !history.solar_power || history.solar_power.length === 0) {
                ctx.fillStyle = '#888';
                ctx.fillText('æš‚æ— æ•°æ®', canvas.width / 2 - 30, canvas.height / 2);
                return;
            }
            
            const dataLength = Math.min(60, history.solar_power.length);
            const startIdx = Math.max(0, history.solar_power.length - dataLength);
            
            const chartWidth = canvas.width - 60;
            const chartHeight = canvas.height - 40;
            
            // æ•°æ®ç³»åˆ—
            const series = [
                { data: history.solar_power, color: '#f1c40f', name: 'å…‰ä¼' },
                { data: history.wind_power, color: '#3498db', name: 'é£ç”µ' },
                { data: history.load_power, color: '#e74c3c', name: 'è´Ÿè·' }
            ];
            
            // æ‰¾æœ€å¤§å€¼
            let maxVal = 0;
            series.forEach(s => {
                if (s.data) {
                    const sliced = s.data.slice(startIdx);
                    maxVal = Math.max(maxVal, ...sliced);
                }
            });
            maxVal = Math.max(maxVal, 100) * 1.1;
            
            // ç»˜åˆ¶æ•°æ®çº¿
            series.forEach(s => {
                if (!s.data || s.data.length === 0) return;
                
                ctx.strokeStyle = s.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const sliced = s.data.slice(startIdx);
                sliced.forEach((val, i) => {
                    const x = 40 + (i / (dataLength - 1)) * chartWidth;
                    const y = (canvas.height - 20) - (val / maxVal) * chartHeight;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            });
            
            // ç»˜åˆ¶å›¾ä¾‹
            let legendX = canvas.width - 150;
            series.forEach((s, i) => {
                ctx.fillStyle = s.color;
                ctx.fillRect(legendX, 10 + i * 18, 12, 12);
                ctx.fillStyle = '#fff';
                ctx.fillText(s.name, legendX + 18, 20 + i * 18);
            });
        }
        
        // èŠå¤©åŠŸèƒ½
        function handleChat(message) {
            const chatMessages = document.getElementById('chat-messages');
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);
            
            // æ¨¡æ‹ŸAIå›å¤
            setTimeout(() => {
                const response = generateResponse(message);
                const sysMsg = document.createElement('div');
                sysMsg.className = 'chat-message system';
                sysMsg.textContent = response;
                chatMessages.appendChild(sysMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 500);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function generateResponse(message) {
            message = message.toLowerCase();
            
            if (message.includes('çŠ¶æ€') || message.includes('status')) {
                return 'å½“å‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚å…‰ä¼å‘ç”µçº¦65kWï¼Œé£ç”µçº¦25kWï¼Œç”µæ± SOC 55%ï¼Œè´Ÿè·çº¦90kWã€‚å¯å†ç”Ÿèƒ½æºåˆ©ç”¨ç‡è¾¾åˆ°85%ã€‚';
            } else if (message.includes('ç”µæ± ') || message.includes('battery')) {
                return 'å‚¨èƒ½ç³»ç»ŸçŠ¶æ€è‰¯å¥½ã€‚å½“å‰SOC: 55%ï¼Œå‰©ä½™å®¹é‡çº¦110kWhï¼Œå¥åº·åº¦98%ã€‚å»ºè®®åœ¨ä½ç”µä»·æ—¶æ®µå……ç”µã€‚';
            } else if (message.includes('æˆæœ¬') || message.includes('cost')) {
                return 'ä»Šæ—¥ç´¯è®¡ç”µè´¹çº¦Â¥45.60ï¼Œæ¯”æ˜¨æ—¥èŠ‚çœ12%ã€‚ä¸»è¦èŠ‚çœæ¥è‡ªå…‰ä¼å‘ç”µé«˜å³°æœŸçš„è‡ªå‘è‡ªç”¨ã€‚';
            } else if (message.includes('é¢„æµ‹') || message.includes('forecast')) {
                return 'æœªæ¥1å°æ—¶é¢„æµ‹: å…‰ä¼å°†ä¿æŒåœ¨50-70kWï¼Œé£ç”µ15-30kWï¼Œè´Ÿè·é¢„è®¡ä¸Šå‡è‡³100kWã€‚å»ºè®®ç»´æŒå½“å‰å‚¨èƒ½ç­–ç•¥ã€‚';
            } else if (message.includes('å¸®åŠ©') || message.includes('help')) {
                return 'æ‚¨å¯ä»¥è¯¢é—®: ç³»ç»ŸçŠ¶æ€ã€ç”µæ± æƒ…å†µã€ä»Šæ—¥æˆæœ¬ã€æœªæ¥é¢„æµ‹ã€ç­–ç•¥å»ºè®®ç­‰ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨æ§åˆ¶é¢æ¿ç›´æ¥æ“ä½œè®¾å¤‡ã€‚';
            } else {
                return 'æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ã€‚å½“å‰ç³»ç»Ÿè¿è¡Œç¨³å®šï¼Œå¦‚éœ€è¯¦ç»†ä¿¡æ¯è¯·è¯¢é—®"ç³»ç»ŸçŠ¶æ€"æˆ–"å¸®åŠ©"ã€‚';
            }
        }
        
        // æ§åˆ¶æŒ‰é’®äº‹ä»¶
        function setupControls() {
            // ç”µæ± æ»‘å—
            document.getElementById('battery-slider').addEventListener('input', function() {
                const value = this.value;
                document.getElementById('battery-action-value').textContent = 
                    (value > 0 ? '+' : '') + value + '%';
            });
            
            // é€Ÿåº¦æ»‘å—
            document.getElementById('speed-slider').addEventListener('input', function() {
                simulationSpeed = parseInt(this.value);
                document.getElementById('speed-value').textContent = simulationSpeed + 'x';
            });
            
            // è‡ªåŠ¨æ¨¡å¼
            document.getElementById('btn-auto').addEventListener('click', function() {
                autoMode = !autoMode;
                this.style.background = autoMode ? 
                    'linear-gradient(135deg, #00d4ff, #0099cc)' : 
                    'linear-gradient(135deg, #666, #444)';
                addChatMessage('system', autoMode ? 'å·²å¯ç”¨è‡ªåŠ¨ä¼˜åŒ–æ¨¡å¼' : 'å·²åˆ‡æ¢è‡³æ‰‹åŠ¨æ¨¡å¼');
            });
            
            // å¿«é€Ÿå……ç”µ
            document.getElementById('btn-charge').addEventListener('click', function() {
                addChatMessage('system', 'âš¡ ç”µæ± å¿«é€Ÿå……ç”µå·²å¯åŠ¨');
            });
            
            // ç«‹å³æ”¾ç”µ
            document.getElementById('btn-discharge').addEventListener('click', function() {
                addChatMessage('system', 'ğŸ”‹ ç”µæ± å¼€å§‹æ”¾ç”µä¾›ç”µ');
            });
            
            // æŸ´æ²¹æœºå¼€å…³
            document.getElementById('btn-diesel').addEventListener('click', function() {
                dieselOn = !dieselOn;
                this.style.background = dieselOn ? 
                    'linear-gradient(135deg, #27ae60, #2ecc71)' : 
                    'linear-gradient(135deg, #e74c3c, #c0392b)';
                addChatMessage('system', dieselOn ? 'ğŸ­ æŸ´æ²¹å‘ç”µæœºå·²å¯åŠ¨' : 'ğŸ›‘ æŸ´æ²¹å‘ç”µæœºå·²åœæ­¢');
            });
            
            // å¼€å§‹/æš‚åœæ¨¡æ‹Ÿ
            document.getElementById('btn-play').addEventListener('click', function() {
                isSimulating = !isSimulating;
                this.textContent = isSimulating ? 'â¸ï¸ æš‚åœæ¨¡æ‹Ÿ' : 'â–¶ï¸ å¼€å§‹æ¨¡æ‹Ÿ';
                if (isSimulating) {
                    if (currentStep === 0) {
                        addChatMessage('system', `ğŸš€ å¼€å§‹${SIMULATION_DAYS}å¤©æ¨¡æ‹Ÿè¿è¡Œï¼ˆå…±${TOTAL_STEPS.toLocaleString()}æ­¥ï¼‰`);
                    }
                    startSimulation();
                }
            });
            
            // é‡ç½®
            document.getElementById('btn-reset').addEventListener('click', function() {
                isSimulating = false;
                currentStep = 0;
                document.getElementById('btn-play').textContent = 'â–¶ï¸ å¼€å§‹æ¨¡æ‹Ÿ';
                window.simHistory = { solar_power: [], wind_power: [], load_power: [] };
                strategyData.training_steps = 0;
                strategyData.buffer_size = 0;
                updateStrategyExecution();
                addChatMessage('system', 'ğŸ”„ ç³»ç»Ÿå·²é‡ç½®ï¼Œå‡†å¤‡å¼€å§‹æ–°çš„ä¸€ä¸ªæœˆæ¨¡æ‹Ÿ');
            });
            
            // èŠå¤©å‘é€
            document.getElementById('send-btn').addEventListener('click', function() {
                const input = document.getElementById('chat-input');
                if (input.value.trim()) {
                    handleChat(input.value.trim());
                    input.value = '';
                }
            });
            
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    handleChat(this.value.trim());
                    this.value = '';
                }
            });
        }
        
        function addChatMessage(type, text) {
            const chatMessages = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = 'chat-message ' + type;
            msg.textContent = text;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ç­–ç•¥é¢æ¿åˆ‡æ¢
        function switchStrategyTab(tab) {
            // æ›´æ–°æ ‡ç­¾
            document.querySelectorAll('.strategy-tab').forEach(t => {
                t.classList.remove('active');
                if (t.textContent.includes(tab === 'execution' ? 'æ‰§è¡Œæƒ…å†µ' : 'ç­–ç•¥å¯¹æ¯”')) {
                    t.classList.add('active');
                }
            });
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.strategy-content').forEach(c => c.classList.remove('active'));
            document.getElementById('strategy-' + tab).classList.add('active');
        }
        
        // æ›´æ–°ç­–ç•¥æ‰§è¡Œæƒ…å†µ
        function updateStrategyExecution() {
            document.getElementById('rl-confidence').textContent = 
                (strategyData.rl_confidence * 100).toFixed(1) + '%';
            document.getElementById('epsilon-value').textContent = 
                strategyData.epsilon.toFixed(4);
            document.getElementById('training-steps').textContent = 
                strategyData.training_steps.toLocaleString();
            document.getElementById('buffer-size').textContent = 
                strategyData.buffer_size.toLocaleString();
            document.getElementById('recent-performance').textContent = 
                strategyData.recent_performance.toFixed(2);
            
            // å½“å‰åŠ¨ä½œ
            const batteryAction = strategyData.current_action.battery_action;
            let batteryText = 'å¾…æœº';
            if (batteryAction > 0.1) {
                batteryText = `å……ç”µ ${(batteryAction * 100).toFixed(0)}%`;
            } else if (batteryAction < -0.1) {
                batteryText = `æ”¾ç”µ ${(Math.abs(batteryAction) * 100).toFixed(0)}%`;
            }
            document.getElementById('current-battery-action').textContent = batteryText;
            document.getElementById('current-diesel-status').textContent = 
                strategyData.current_action.diesel_on ? 'è¿è¡Œä¸­' : 'å…³é—­';
        }
        
        // è¿è¡Œç­–ç•¥å¯¹æ¯”
        function runStrategyComparison() {
            // æ¨¡æ‹Ÿç­–ç•¥å¯¹æ¯”æ•°æ®
            comparisonData.rl = {
                cost: Math.random() * 1000 + 500,
                renewable: Math.random() * 20 + 70,
                rank: 1
            };
            comparisonData.rule = {
                cost: comparisonData.rl.cost + Math.random() * 200,
                renewable: comparisonData.rl.renewable - Math.random() * 10,
                rank: 2
            };
            comparisonData.random = {
                cost: comparisonData.rl.cost + Math.random() * 500 + 200,
                renewable: comparisonData.rl.renewable - Math.random() * 20,
                rank: 3
            };
            
            // æ›´æ–°è¡¨æ ¼
            document.getElementById('rl-cost').textContent = 'Â¥' + comparisonData.rl.cost.toFixed(2);
            document.getElementById('rl-renewable').textContent = comparisonData.rl.renewable.toFixed(1) + '%';
            document.getElementById('rl-rank').textContent = comparisonData.rl.rank;
            
            document.getElementById('rule-cost').textContent = 'Â¥' + comparisonData.rule.cost.toFixed(2);
            document.getElementById('rule-renewable').textContent = comparisonData.rule.renewable.toFixed(1) + '%';
            document.getElementById('rule-rank').textContent = comparisonData.rule.rank;
            
            document.getElementById('random-cost').textContent = 'Â¥' + comparisonData.random.cost.toFixed(2);
            document.getElementById('random-renewable').textContent = comparisonData.random.renewable.toFixed(1) + '%';
            document.getElementById('random-rank').textContent = comparisonData.random.rank;
            
            addChatMessage('system', 'ç­–ç•¥å¯¹æ¯”åˆ†æå®Œæˆï¼');
        }
        
        // æ¨¡æ‹Ÿè¿è¡Œï¼ˆä¸€ä¸ªæœˆå‘¨æœŸï¼‰
        function startSimulation() {
            if (!isSimulating) return;
            
            // è®¡ç®—å½“å‰æ¨¡æ‹Ÿæ—¶é—´ï¼ˆåŸºäºæ­¥æ•°ï¼‰
            const daysElapsed = Math.floor(currentStep / (24 * 60));
            const hoursElapsed = Math.floor((currentStep % (24 * 60)) / 60);
            const minutesElapsed = currentStep % 60;
            
            // è®¡ç®—å½“å‰å°æ—¶ï¼ˆ0-23ï¼‰
            const hour = hoursElapsed;
            const dayOfYear = daysElapsed % 365;
            
            // æ¨¡æ‹ŸçŠ¶æ€æ›´æ–°ï¼ˆè€ƒè™‘å­£èŠ‚å˜åŒ–ï¼‰
            const seasonalFactor = 0.7 + 0.3 * Math.sin(2 * Math.PI * (dayOfYear - 80) / 365);
            const solarBase = Math.sin((hour - 6) * Math.PI / 12) * 80 * seasonalFactor;
            const solar = Math.max(0, solarBase + (Math.random() - 0.5) * 20);
            const wind = (15 + Math.random() * 20) * (0.8 + 0.4 * Math.sin(2 * Math.PI * dayOfYear / 365));
            const load = 80 + Math.sin(hour * Math.PI / 12) * 40 + (Math.random() - 0.5) * 20;
            
            // è®¡ç®—SOCï¼ˆåŸºäºç´¯è®¡å……æ”¾ç”µï¼‰
            const baseSOC = 0.5;
            const socVariation = Math.sin(currentStep * 0.01) * 0.2;
            const batterySOC = Math.max(0.1, Math.min(0.9, baseSOC + socVariation));
            
            // è®¡ç®—ç´¯è®¡æˆæœ¬ï¼ˆåŸºäºæ­¥æ•°ï¼‰
            const costPerStep = 0.1;
            const totalCost = currentStep * costPerStep;
            
            // è®¡ç®—ç´¯è®¡å¯å†ç”Ÿèƒ½æº
            const renewablePerStep = (solar + wind) / 60;
            const totalRenewable = currentStep * renewablePerStep;
            const totalConsumed = currentStep * load / 60;
            const renewableRatio = totalConsumed > 0 ? totalRenewable / totalConsumed : 0;
            
            const mockState = {
                timestamp: new Date().toISOString(),
                components: {
                    solar: { current_power: solar, capacity: 100 },
                    wind: { current_power: wind, capacity: 50 },
                    battery: { soc: batterySOC, capacity: 200, health: 0.98 },
                    load: { current: load, base: 80, peak: 150 },
                    grid: { connected: true }
                },
                weather: {
                    temperature: 20 + Math.sin(2 * Math.PI * dayOfYear / 365) * 10 + Math.random() * 5,
                    wind_speed: 5 + Math.random() * 10,
                    irradiance: solar * 10,
                    cloud_cover: Math.random() * 0.5,
                    humidity: 50 + Math.random() * 30
                },
                price: {
                    buy_price: hour >= 9 && hour < 12 || hour >= 17 && hour < 21 ? 1.2 : 
                              hour >= 23 || hour < 7 ? 0.4 : 0.8,
                    sell_price: (hour >= 9 && hour < 12 || hour >= 17 && hour < 21 ? 1.2 : 
                                 hour >= 23 || hour < 7 ? 0.4 : 0.8) * 0.7,
                    period: hour >= 9 && hour < 12 || hour >= 17 && hour < 21 ? 'peak' :
                           hour >= 23 || hour < 7 ? 'valley' : 'normal'
                },
                statistics: {
                    total_cost: totalCost,
                    total_renewable_energy: totalRenewable,
                    total_energy_consumed: totalConsumed,
                    renewable_ratio: renewableRatio
                }
            };
            
            // æ›´æ–°ç­–ç•¥æ•°æ®
            strategyData.rl_confidence = 0.5 + Math.sin(currentStep * 0.001) * 0.2;
            strategyData.epsilon = Math.max(0.01, 1.0 - currentStep / 10000);
            strategyData.training_steps = currentStep;
            strategyData.buffer_size = Math.min(100000, currentStep * 10);
            strategyData.recent_performance = Math.sin(currentStep * 0.01) * 10 + 50;
            strategyData.current_action = {
                battery_action: Math.sin(currentStep * 0.02) * 0.5,
                diesel_on: load > solar + wind + 50
            };
            
            updateDisplay(mockState);
            updateStrategyExecution();
            
            // æ›´æ–°å†å²æ•°æ®ç”¨äºå›¾è¡¨ï¼ˆä¿ç•™æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼‰
            if (!window.simHistory) {
                window.simHistory = { solar_power: [], wind_power: [], load_power: [] };
            }
            window.simHistory.solar_power.push(solar);
            window.simHistory.wind_power.push(wind);
            window.simHistory.load_power.push(load);
            
            // åªä¿ç•™æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ˆ1440åˆ†é’Ÿï¼‰
            const maxHistoryLength = 1440;
            if (window.simHistory.solar_power.length > maxHistoryLength) {
                window.simHistory.solar_power.shift();
                window.simHistory.wind_power.shift();
                window.simHistory.load_power.shift();
            }
            
            drawChart(window.simHistory);
            
            // æ›´æ–°è¿›åº¦
            currentStep++;
            const progress = (currentStep / TOTAL_STEPS * 100).toFixed(1);
            const daysRemaining = Math.ceil((TOTAL_STEPS - currentStep) / (24 * 60));
            
            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºè¿›åº¦
            const header = document.querySelector('#header h1');
            if (header) {
                header.textContent = `ğŸ”Œ å¾®ç½‘æ•°å­—å­ªç”Ÿç³»ç»Ÿ - 3Då¯è§†åŒ–æ§åˆ¶ä¸­å¿ƒ (${progress}% - å‰©ä½™${daysRemaining}å¤©)`;
            }
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (currentStep >= TOTAL_STEPS) {
                isSimulating = false;
                document.getElementById('btn-play').textContent = 'â–¶ï¸ å¼€å§‹æ¨¡æ‹Ÿ';
                addChatMessage('system', `âœ… æ¨¡æ‹Ÿå®Œæˆï¼å·²å®Œæˆ${SIMULATION_DAYS}å¤©çš„æ¨¡æ‹Ÿè¿è¡Œã€‚`);
                return;
            }
            
            setTimeout(() => startSimulation(), 1000 / simulationSpeed);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initScene();
            animate();
            setupControls();
            
            // åˆå§‹æ˜¾ç¤º
            if (systemState && Object.keys(systemState).length > 0) {
                updateDisplay(systemState);
            }
            
            if (historyData && Object.keys(historyData).length > 0) {
                drawChart(historyData);
            } else {
                drawChart(null);
            }
            
            // åˆå§‹åŒ–ç­–ç•¥æ˜¾ç¤º
            updateStrategyExecution();
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDetailModal();
                }
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDetailModal();
                }
            });
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            addChatMessage('system', `ç³»ç»Ÿå·²å°±ç»ªã€‚æ¨¡æ‹Ÿå‘¨æœŸï¼š${SIMULATION_DAYS}å¤©ï¼ˆ${TOTAL_STEPS.toLocaleString()}æ­¥ï¼‰ã€‚ç‚¹å‡»3Dåœºæ™¯ä¸­çš„è®¾å¤‡å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚`);
        });
    </script>
</body>
</html>
